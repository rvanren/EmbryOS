\chapter{Writing to the Screen (Text Mode)}

In Chapter~1 we printed ``Hello~World'' to the UART.  That was enough to verify
that EmbryOS could talk to the outside world.  In this chapter we will build a
tiny \texttt{stdio} library so that we can write more expressive output---clear
the screen, move the cursor, and even print numbers and colors.

\section{A Minimal Standard I/O Library}

For convenience, we place all screen and output routines in three files:
\texttt{stdio.h}, \texttt{stdio.c}, and \texttt{hello.c}.  The header
\texttt{stdio.h} declares two functions, shown in
Listing~\ref{lst:stdio_h}.

\begin{figure}[H]
\centering
\begin{minipage}{0.7\textwidth}
\lstinputlisting[
  style=oscode,
  language=C,
  caption={Header file \texttt{stdio.h}},
  label={lst:stdio_h}
]{../code/chapter2/stdio.h}
\end{minipage}
\end{figure}

The implementation, shown in Listing~\ref{lst:stdio_c}, provides a
\texttt{printf()} that understands four format specifiers:
\texttt{\%d}, \texttt{\%x}, \texttt{\%s}, and \texttt{\%c}.  It depends on
\texttt{putchar()}, which writes a single character to the UART.

\begin{figure}[H]
\centering
\begin{minipage}{0.9\textwidth}
\lstinputlisting[
  style=oscode,
  language=C,
  caption={Implementation of \texttt{printf()} in \texttt{stdio.c}},
  label={lst:stdio_c}
]{../code/chapter2/stdio.c}
\end{minipage}
\end{figure}

This version of \texttt{printf()} is small---less than fifty lines---but it is
already powerful enough to print numbers, strings, and characters.  The
\texttt{<stdarg.h>} header allows variable argument lists using the macros
\texttt{va\_start()}, \texttt{va\_arg()}, and \texttt{va\_end()}.  The helper
function \texttt{print\_unsigned()} converts integers into text in base~10 or
base~16.

\section{Text-Mode Graphics}

With a proper \texttt{printf()} available, we can use ANSI escape sequences to
control the terminal as if it were a screen.  The UART sends characters, but
the terminal emulator interprets certain special sequences beginning with the
escape character (\texttt{\textbackslash033}) as commands such as ``move the
cursor'' or ``set color.''

Listing~\ref{lst:ch2_hello_c} shows the complete program.

\begin{figure}[H]
\centering
\begin{minipage}{0.9\textwidth}
\lstinputlisting[
  style=oscode,
  language=C,
  caption={Text-mode screen demo in \texttt{hello.c}},
  label={lst:ch2_hello_c}
]{../code/chapter2/hello.c}
\end{minipage}
\end{figure}

The functions:

\begin{itemize}
  \item \texttt{clear\_screen()} sends the escape codes
        \texttt{[2J[H]} to erase the display and return the cursor to the
        top-left corner.
  \item \texttt{move\_cursor(row,col)} positions the cursor at a chosen location.
  \item \texttt{set\_color(color)} changes the text color
        (\texttt{0=black}, \texttt{1=red}, â€¦, \texttt{7=white}).
\end{itemize}

The \texttt{main()} function clears the screen, then prints
``EmbryOS~says~hello!'' in six different colors at different positions.

\section{Running the Program}

Build and run the program as before:

\begin{lstlisting}[style=oscode,language=bash]
$ make qemu
\end{lstlisting}

or equivalently,

\begin{lstlisting}[style=oscode,language=bash]
$ qemu-system-riscv32 -machine sifive_u -nographic -bios hello.bin
\end{lstlisting}

The terminal will clear and display a vertical rainbow of messages.  Even
though we are using the same UART device, the terminal emulator interprets the
escape sequences as screen-control commands.

\section{Projects}

\begin{enumerate}
  \item \textbf{Progress bar.}
        Print a single line that gradually fills with `\#' characters to
        simulate progress.  Use \texttt{move\_cursor()} to update it in place.
  \item \textbf{Color cycling.}
        Print the same message repeatedly, changing colors each time.
  \item \textbf{Boot animation.}
        Combine the above effects into a short animation for EmbryOS startup.
\end{enumerate}

\section*{Summary}

In this chapter we moved from simple character output to full control over a
text-mode ``screen.''  We also built a minimal but real implementation of
\texttt{printf()}, giving EmbryOS the ability to print formatted output without
any external libraries.  In the next chapter we will make the system reactive
by introducing timer interrupts.
